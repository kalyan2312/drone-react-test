kind: pipeline
type: docker
name: default
environment:
  REGISTRY: 676472291562.dkr.ecr.us-east-1.amazonaws.com

workspace:
  path: /myproject

steps:
  - name: build
    image: amazon/aws-cli
    commands:
      - aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $REGISTRY
      - docker build -t $REGISTRY/${DRONE_REPO_NAME}:${DRONE_COMMIT_BRANCH}-${DRONE_COMMIT_SHA:0:8} .   
  - name: install dependencies and build
    image: node:16
    commands:
      - npm install
      - npm run build
    volumes:
     - name: buildFiles
       path: /myproject/build
  
  - name: upload to s3
    image: plugins/s3
    volumes:
     - name: buildFiles
       path: /myproject/build
    settings:
      bucket: drone-react-test
      region: us-east-1
      access_key:
        from_secret: access_key
      secret_key:
        from_secret: secret_key
      source: /myproject/build/**/*
      target: /

volumes:
- name: buildFiles
  temp: {}
